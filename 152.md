讓我詳細為你解釋 PostgreSQL 的行級安全策略（Row Level Security, RLS）。

## 什麼是 RLS？

RLS 允許你在資料表級別控制哪些行可以被使用者存取，實現細粒度的權限控制。

## 基本設定步驟

### 1. 啟用 RLS

```sql
-- 建立範例資料表
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT,
    owner_id TEXT,  -- 文件擁有者
    team_id TEXT,   -- 團隊ID
    is_public BOOLEAN DEFAULT false
);

-- 啟用 RLS
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;
```

### 2. 建立策略（Policies）

```sql
-- 策略1：使用者可以看到自己的文件
CREATE POLICY user_see_own_docs ON documents
    FOR SELECT
    USING (owner_id = current_user);

-- 策略2：使用者可以新增自己的文件
CREATE POLICY user_insert_own_docs ON documents
    FOR INSERT
    WITH CHECK (owner_id = current_user);

-- 策略3：使用者可以更新自己的文件
CREATE POLICY user_update_own_docs ON documents
    FOR UPDATE
    USING (owner_id = current_user);

-- 策略4：使用者可以刪除自己的文件
CREATE POLICY user_delete_own_docs ON documents
    FOR DELETE
    USING (owner_id = current_user);
```

## 進階策略範例

### 團隊存取控制

```sql
-- 假設有團隊成員表
CREATE TABLE team_members (
    team_id TEXT,
    user_id TEXT,
    role TEXT
);

-- 團隊成員可以查看團隊文件
CREATE POLICY team_see_docs ON documents
    FOR SELECT
    USING (
        is_public = true 
        OR owner_id = current_user 
        OR EXISTS (
            SELECT 1 FROM team_members 
            WHERE team_members.team_id = documents.team_id 
            AND team_members.user_id = current_user
        )
    );
```

### 基於角色的存取控制

```sql
-- 管理員可以存取所有資料
CREATE POLICY admin_all_access ON documents
    FOR ALL
    USING (current_user IN ('admin', 'superuser'));

-- 經理可以查看所屬部門的所有文件
CREATE POLICY manager_department_access ON documents
    FOR SELECT
    USING (
        department_id IN (
            SELECT department_id FROM managers 
            WHERE user_id = current_user
        )
    );
```

## 實際應用範例

```sql
-- 完整的部落格系統範例
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT,
    author_id TEXT NOT NULL,
    status TEXT CHECK (status IN ('draft', 'published', 'archived')),
    created_at TIMESTAMP DEFAULT NOW()
);

ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

-- 作者可以對自己的文章進行所有操作
CREATE POLICY author_full_access ON posts
    FOR ALL
    USING (author_id = current_user);

-- 所有人都可以查看已發布的文章
CREATE POLICY public_read_published ON posts
    FOR SELECT
    USING (status = 'published');

-- 管理員有完整存取權限
CREATE POLICY admin_full_access ON posts
    FOR ALL
    USING (EXISTS (
        SELECT 1 FROM users 
        WHERE users.id = current_user 
        AND users.role = 'admin'
    ));
```

## 測試 RLS

```sql
-- 建立測試使用者
CREATE USER alice;
CREATE USER bob;
CREATE USER admin_user;

-- 插入測試資料
INSERT INTO posts (title, content, author_id, status) VALUES
('Alice的草稿', '內容...', 'alice', 'draft'),
('Alice的公開文章', '內容...', 'alice', 'published'),
('Bob的文章', '內容...', 'bob', 'published');

-- 切換到不同使用者測試
SET ROLE alice;
SELECT * FROM posts;  -- alice 只能看到自己的文章和已發布的文章

SET ROLE bob;
SELECT * FROM posts;  -- bob 只能看到自己的文章和已發布的文章
```

## 重要注意事項

### 1. 超級使用者繞過 RLS
```sql
-- 超級使用者不受 RLS 限制
-- 確保只有必要人員有超級使用者權限
```

### 2. 預設拒絕所有
啟用 RLS 後，如果沒有建立策略，預設拒絕所有操作。

### 3. 多策略處理
```sql
-- 多個策略使用 OR 連接
-- 可以使用 PERMISSIVE（預設，OR）或 RESTRICTIVE（AND）
CREATE POLICY restrictive_policy ON documents
    AS RESTRICTIVE
    FOR SELECT
    USING (condition1 AND condition2);
```

### 4. 效能考慮
```sql
-- 避免複雜的子查詢
-- 使用索引支援的條件
-- 考慮物化視圖或函數來優化效能
```

## 除錯技巧

```sql
-- 檢查現有策略
SELECT * FROM pg_policies WHERE tablename = 'documents';

-- 檢查 RLS 是否啟用
SELECT tablename, rowsecurity FROM pg_tables 
WHERE tablename = 'documents';

-- 使用 EXPLAIN 查看查詢計劃
EXPLAIN ANALYZE SELECT * FROM documents;
```

## 最佳實踐

1. **最小權限原則**：只授予必要的最小存取權限
2. **明確的策略命名**：使用有意義的策略名稱
3. **測試充分**：使用不同使用者角色測試策略
4. **文件記錄**：記錄所有策略及其目的
5. **定期審查**：定期檢查和更新策略

## 常見問題解決

```sql
-- 問題：忘記為 INSERT 設定策略
-- 解決：建立 INSERT 策略
CREATE POLICY allow_insert ON documents
    FOR INSERT
    WITH CHECK (owner_id = current_user);

-- 問題：效能問題
-- 解決：確保條件欄位有索引
CREATE INDEX idx_documents_owner_id ON documents(owner_id);
CREATE INDEX idx_documents_team_id ON documents(team_id);
```

RLS 是實現多租戶應用程式和複雜權限系統的強大工具，正確使用可以大大簡化應用程式層的權限邏輯。
