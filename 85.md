### 學習與練習 PostgreSQL、PostgREST 和 PgBouncer 的完整指南

以下是為初學者設計的結構化學習路徑，包含概念說明、安裝步驟、實戰範例和進階整合：

---

#### **1. PostgreSQL 基礎**
**核心概念**：
- 關聯式資料庫管理系統（RDBMS）
- SQL 語法（`SELECT`/`INSERT`/`UPDATE`/`DELETE`）
- 資料表、索引、視圖（Views）、觸發器（Triggers）
- 使用者權限管理（Roles）

**安裝與練習**：
```bash
# Ubuntu 安裝
sudo apt update
sudo apt install postgresql postgresql-contrib

# 啟動服務
sudo systemctl start postgresql

# 連接到資料庫
sudo -u postgres psql

# 基本操作範例
CREATE DATABASE mydb;
\c mydb  -- 切換資料庫

CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(50),
  email VARCHAR(100) UNIQUE
);

INSERT INTO users (name, email) VALUES 
  ('Alice', 'alice@example.com'),
  ('Bob', 'bob@example.com');
```

**練習任務**：
1. 創建 `products` 表格（含 id, name, price）
2. 使用 `JOIN` 查詢使用者和其購買的產品
3. 建立索引加速 email 搜尋
4. 設定使用者權限：`GRANT SELECT ON users TO readonly_user;`

---

#### **2. PostgREST 實戰**
**核心概念**：
- 將 PostgreSQL 資料庫直接轉換為 RESTful API
- 自動生成 CRUD 端點（`GET`/`POST`/`PUT`/`DELETE`）
- 透過資料庫角色控制 API 權限

**安裝與設定**：
```bash
# 下載二進位檔 (Linux)
wget https://github.com/PostgREST/postgrest/releases/download/v10.1.1/postgrest-v10.1.1-linux-static-x64.tar.xz
tar xf postgrest-*.tar.xz
sudo mv postgrest /usr/local/bin/

# 建立設定檔 api.conf
echo '
db-uri = "postgres://authenticator:mysecret@localhost:5432/mydb"
db-schemas = "public"
db-anon-role = "web_anon"
' > api.conf
```

**資料庫權限設定**：
```sql
-- 在 psql 中執行
CREATE ROLE web_anon NOLOGIN;
GRANT USAGE ON SCHEMA public TO web_anon;
GRANT SELECT ON users TO web_anon;

CREATE ROLE authenticator NOINHERIT LOGIN PASSWORD 'mysecret';
GRANT web_anon TO authenticator;
```

**啟動與測試**：
```bash
# 啟動 API 服務
postgrest api.conf

# 測試 API
curl http://localhost:3000/users
```

**練習任務**：
1. 創建 `/products` 端點
2. 實現 JWT 身份驗證（參考官方文件）
3. 使用視圖（View）創建自訂 API 端點
4. 限制 API 只返回特定欄位（`?select=name,email`）

---

#### **3. PgBouncer 連線池管理**
**核心概念**：
- 解決 PostgreSQL 連線數限制（預設約 100 個）
- 三種池化模式：
  - **Session**（預設）：連線在整個會話期間保持
  - **Transaction**：連線在事務結束後釋放
  - **Statement**：每條查詢後釋放（不推薦）

**安裝與設定**：
```bash
# Ubuntu 安裝
sudo apt install pgbouncer

# 編輯設定檔 /etc/pgbouncer/pgbouncer.ini
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
listen_port = 6432
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 20
```

**連接測試**：
```bash
# 透過 PgBouncer 連線
psql -p 6432 -U postgres mydb

# 查看池狀態
psql -p 6432 pgbouncer -c "SHOW POOLS"
```

**整合 PostgREST**：
修改 PostgREST 設定：
```ini
# api.conf
db-uri = "postgres://authenticator:mysecret@localhost:6432/mydb"
```

---

#### **4. 整合實戰專案**
**架構**：
```
用戶端 → PostgREST (API) → PgBouncer (連線池) → PostgreSQL
```

**操作步驟**：
1. 在 PostgreSQL 創建專案資料庫
   ```sql
   CREATE DATABASE ecommerce;
   CREATE TABLE orders (id SERIAL, user_id INT, product TEXT);
   ```

2. 設定 PgBouncer 連接到 `ecommerce` 資料庫
   ```ini
   [databases]
   ecom = host=localhost port=5432 dbname=ecommerce
   ```

3. 設定 PostgREST 權限角色
   ```sql
   CREATE ROLE api_user NOLOGIN;
   GRANT ALL ON orders TO api_user;
   ```

4. 啟動所有服務：
   ```bash
   sudo systemctl restart postgresql
   sudo systemctl restart pgbouncer
   postgrest api.conf
   ```

5. 測試完整流程：
   ```bash
   # 新增訂單
   curl http://localhost:3000/orders -X POST \
     -H "Content-Type: application/json" \
     -d '{"user_id": 1, "product": "Laptop"}'
   ```

---

#### **5. 進階學習資源**
- **PostgreSQL**：
  - [官方文件](https://www.postgresql.org/docs/current/)
  - 學習視窗函數（Window Functions）和 CTE（Common Table Expressions）
- **PostgREST**：
  - [進階 API 設計](https://postgrest.org/en/stable/api.html)
  - 儲存過程（Stored Procedures）整合
- **PgBouncer**：
  - [連線池優化指南](https://www.pgbouncer.org/config.html)
  - TLS/SSL 加密設定
- **監控工具**：
  - 使用 `pg_stat_activity` 分析資料庫負載
  - Prometheus + Grafana 監控 PgBouncer

---

#### **故障排除技巧**
1. **連線失敗**：
   - 檢查 `pg_hba.conf` 權限設定
   - 驗證 PgBouncer 的 `[databases]` 設定

2. **API 無回應**：
   - 確認 PostgREST 日誌（預設輸出到 stdout）
   - 檢查資料庫角色權限是否正確

3. **效能問題**：
   ```sql
   -- 找出慢查詢
   SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 5;
   ```
   - 調整 PgBouncer 的 `default_pool_size`

---

透過此指南，你將掌握從基礎操作到生產環境整合的全流程。建議逐步實作每個部分，並使用 Docker 建立練習環境避免影響主系統。遇到問題時，善用官方文件和社群資源（如 Stack Overflow）！
