ä½ é€™æ®µæµç¨‹æ˜¯ **TLS 1.3 çš„ handshake æµç¨‹å°åŒ…ç´€éŒ„**ï¼Œæˆ‘å¹«ä½ è§£é‡‹æ¯å€‹æ­¥é©Ÿï¼Œç„¶å¾Œç”¨ Mermaid ç”¢ç”Ÿä¸€å€‹é †åºåœ–ä¾†å¹«åŠ©ç†è§£ã€‚

---

## æµç¨‹è§£æž

1. **Client Hello (OUT)**

   * Client å‘ Server ç™¼èµ·æ¡æ‰‹ï¼Œå‚³é€æ”¯æ´çš„å¯†ç¢¼å¥—ä»¶ã€TLS ç‰ˆæœ¬ã€éš¨æ©Ÿæ•¸ (random)ã€Session IDã€æ“´å……åƒæ•¸ (å¦‚ SNI)ã€‚

2. **Server Hello (IN)**

   * Server å›žæ‡‰é¸å®šçš„å¯†ç¢¼å¥—ä»¶ã€TLS ç‰ˆæœ¬ã€éš¨æ©Ÿæ•¸ï¼Œä¸¦é–‹å§‹å»ºç«‹å¯†é‘°å”å•†ã€‚

3. **Encrypted Extensions (IN)**

   * Server å‚³é€é¡å¤–çš„å”å•†åƒæ•¸ (ä¾‹å¦‚ ALPNã€SNI é©—è­‰)ï¼Œå·²ç¶“æ˜¯åŠ å¯†ç‹€æ…‹ä¸‹çš„å°åŒ…ã€‚

4. **Certificate (IN)**

   * Server å‚³é€æ†‘è­‰éˆ (åŒ…å«ä¼ºæœå™¨æ†‘è­‰)ï¼Œç”¨ä¾†è®“ Client é©—è­‰ä¼ºæœå™¨èº«ä»½ã€‚

5. **Certificate Verify (IN)**

   * Server ä½¿ç”¨æ†‘è­‰ç§é‘°å°æ¡æ‰‹è¨Šæ¯åšç°½åï¼Œè­‰æ˜Žè‡ªå·±æ“æœ‰è©²æ†‘è­‰çš„ç§é‘°ã€‚

6. **Finished (IN)**

   * Server å®Œæˆæ¡æ‰‹ï¼Œé€å‡º **Finished** è¨Šæ¯ï¼Œé€™è¡¨ç¤ºä¼ºæœå™¨ç«¯æ¡æ‰‹å®Œæˆã€‚

7. **Change Cipher Spec (OUT)**

   * Client é€å‡ºã€Œåˆ‡æ›åˆ°åŠ å¯†é€šé“ã€çš„è¨Šè™Ÿï¼Œä¹‹å¾Œçš„é€šè¨Šæœƒé€²å…¥åŠ å¯†ç‹€æ…‹ã€‚

8. **Finished (OUT)**

   * Client å‚³é€ **Finished** è¨Šæ¯ï¼Œè¡¨ç¤ºæ¡æ‰‹å®Œæˆï¼ŒæŽ¥ä¸‹ä¾†é€²å…¥å®‰å…¨è³‡æ–™å‚³è¼¸éšŽæ®µã€‚

---

## Mermaid é †åºåœ–

```mermaid
sequenceDiagram
    participant Client
    participant Server

    Client->>Server: Client Hello
    Server-->>Client: Server Hello
    Server-->>Client: Encrypted Extensions
    Server-->>Client: Certificate
    Server-->>Client: Certificate Verify
    Server-->>Client: Finished
    Client->>Server: Change Cipher Spec
    Client->>Server: Finished
```

---

ðŸ‘‰ é€™æ¨£çš„é †åºåœ–å°±æ˜¯ TLS 1.3 çš„æ¡æ‰‹æµç¨‹ï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯¦éš›ä¸Šé‚„æœ‰ KeyShareã€æ—©æœŸæ•¸æ“šç­‰å¯èƒ½çš„ç´°ç¯€ï¼‰ã€‚

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ **KeyShare (DH/ECDH é‡‘é‘°äº¤æ›)** ä¹Ÿè£œä¸Šï¼Ÿå› ç‚ºåœ¨ TLS 1.3ï¼ŒClientHello èˆ‡ ServerHello è£¡é¢æœ€é‡è¦çš„å°±æ˜¯ KeyShare æ‰èƒ½å°Žå‡º session keyã€‚



```bash
#!/bin/bash
HOST="example.com"
PORT=443

echo "===== TLS VERSION TEST ====="
for v in --tlsv1 --tlsv1.1 --tlsv1.2 --tlsv1.3; do
  echo -e "\nTesting $v ..."
  curl -vk $v https://$HOST:$PORT/ -o /dev/null 2>&1 | grep "SSL_connect"
done

echo -e "\n===== ALPN TEST ====="
for alpn in "" "h2" "http/1.1"; do
  if [ -z "$alpn" ]; then
    echo -e "\nTesting without ALPN ..."
    openssl s_client -connect $HOST:$PORT -servername $HOST </dev/null 2>&1 | grep "Protocol\|Cipher\|ALPN"
  else
    echo -e "\nTesting ALPN=$alpn ..."
    openssl s_client -connect $HOST:$PORT -servername $HOST -alpn $alpn </dev/null 2>&1 | grep "Protocol\|Cipher\|ALPN"
  fi
done

echo -e "\n===== CIPHER SUITE TEST (TLS 1.2) ====="
for cipher in $(openssl ciphers 'ALL:eNULL' | tr ':' ' '); do
  echo -n "Testing cipher: $cipher ... "
  echo | openssl s_client -connect $HOST:$PORT -servername $HOST -cipher $cipher -tls1_2 2>/dev/null | grep "Cipher is" || echo "FAILED"
done

```
