ç•¶ç„¶å¯ä»¥ï¼ŒLeoï¼é¤˜å¼¦ç›¸ä¼¼åº¦ï¼ˆ**cosine similarity**ï¼‰æ˜¯èªæ„æª¢ç´¢ä¸­æœ€å¸¸ç”¨çš„å‘é‡æ¯”å°æ–¹æ³•ä¹‹ä¸€ï¼Œå®ƒèƒ½è¡¡é‡å…©å€‹å‘é‡åœ¨èªæ„ç©ºé–“ä¸­çš„ã€Œæ–¹å‘ç›¸ä¼¼åº¦ã€ï¼Œè€Œä¸æ˜¯ã€Œè·é›¢æˆ–å¤§å°ã€ã€‚é€™éå¸¸é©åˆç”¨ä¾†æ¯”è¼ƒæ–‡å­—ã€æ–‡ä»¶æˆ–åµŒå…¥å‘é‡çš„èªæ„é—œä¿‚ã€‚

---

## ğŸ“ é¤˜å¼¦ç›¸ä¼¼åº¦çš„æ•¸å­¸å®šç¾©

çµ¦å®šå…©å€‹å‘é‡ $A$ å’Œ $B$ï¼Œé¤˜å¼¦ç›¸ä¼¼åº¦çš„å…¬å¼å¦‚ä¸‹ï¼š

$$
\text{cosine\_similarity}(A, B) = \frac{A \cdot B}{\|A\| \cdot \|B\|}
$$

- $A \cdot B$ æ˜¯å‘é‡çš„**å…§ç©**
- $\|A\|$ å’Œ $\|B\|$ æ˜¯å‘é‡çš„**é•·åº¦ï¼ˆL2 ç¯„æ•¸ï¼‰**

---

## ğŸ¯ ç‚ºä»€éº¼ä½¿ç”¨é¤˜å¼¦ç›¸ä¼¼åº¦ï¼Ÿ

- âœ… **å¿½ç•¥å‘é‡å¤§å°ï¼Œåªçœ‹æ–¹å‘**ï¼šå³ä½¿ä¸€ç¯‡æ–‡ä»¶æ¯”å¦ä¸€ç¯‡é•·å¾ˆå¤šï¼Œåªè¦èªæ„ç›¸è¿‘ï¼Œé¤˜å¼¦ç›¸ä¼¼åº¦ä»ç„¶é«˜ã€‚
- âœ… **å€¼åŸŸå›ºå®šåœ¨ [-1, 1]**ï¼š
  - 1ï¼šå®Œå…¨ç›¸åŒæ–¹å‘ï¼ˆèªæ„ä¸€è‡´ï¼‰
  - 0ï¼šå®Œå…¨ä¸ç›¸é—œï¼ˆå‚ç›´ï¼‰
  - -1ï¼šå®Œå…¨ç›¸åï¼ˆèªæ„å°ç«‹ï¼‰

> åœ¨è‡ªç„¶èªè¨€è™•ç†ä¸­ï¼Œå‘é‡é€šå¸¸æ˜¯éè² çš„ï¼ˆä¾‹å¦‚ TF-IDF æˆ–åµŒå…¥å‘é‡ï¼‰ï¼Œæ‰€ä»¥å¯¦éš›å€¼åŸŸé€šå¸¸æ˜¯ [0, 1]ã€‚

---

## ğŸ§ª Python å¯¦ä½œç¯„ä¾‹

```python
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity

vec1 = np.array([1, 2, 3])
vec2 = np.array([4, 5, 6])

similarity = cosine_similarity(vec1.reshape(1, -1), vec2.reshape(1, -1))
print(similarity[0][0])  # è¼¸å‡ºï¼š0.974631846
```

é€™è¡¨ç¤ºå…©å€‹å‘é‡çš„èªæ„éå¸¸æ¥è¿‘ã€‚

---

## ğŸ“Š åœ¨èªæ„æª¢ç´¢ä¸­çš„æ‡‰ç”¨

åœ¨ LangChain çš„èªæ„æœå°‹æµç¨‹ä¸­ï¼Œé¤˜å¼¦ç›¸ä¼¼åº¦è¢«ç”¨ä¾†ï¼š
- æ¯”å°æŸ¥è©¢å‘é‡èˆ‡æ–‡ä»¶å‘é‡çš„èªæ„è·é›¢
- æ’åºæœ€ç›¸è¿‘çš„æ®µè½
- å›å‚³ç›¸ä¼¼åº¦åˆ†æ•¸ï¼ˆä¾‹å¦‚ `.similarity_search_with_score()`ï¼‰

é€™è®“ä½ å¯ä»¥ç”¨è‡ªç„¶èªè¨€å•é¡Œä¾†æŸ¥è©¢éçµæ§‹åŒ–è³‡æ–™ï¼ˆå¦‚ PDFã€ç¶²é ã€ç­†è¨˜ç­‰ï¼‰ï¼Œè€Œä¸éœ€è¦ç²¾ç¢ºé—œéµå­—ã€‚

---

å¦‚æœä½ æƒ³é€²ä¸€æ­¥äº†è§£å¦‚ä½•è‡ªè¨‚ç›¸ä¼¼åº¦é‚è¼¯ï¼ˆä¾‹å¦‚ä½¿ç”¨ MMR æˆ–è¨­å®šåˆ†æ•¸é–€æª»ï¼‰ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¹«ä½ è¨­è¨ˆä¸€å€‹é€²éšæª¢ç´¢å™¨ã€‚è¦ä¸è¦æˆ‘å¹«ä½ å¯«ä¸€å€‹å¯è¦–åŒ–æ¯”å°çš„å°å·¥å…·ï¼ŸğŸ¤“


ç•¶ç„¶å¯ä»¥ï¼ŒLeoï¼ä»¥ä¸‹æ˜¯ç”¨ Rust å¯¦ä½œ **cosine similarityï¼ˆé¤˜å¼¦ç›¸ä¼¼åº¦ï¼‰** çš„ç°¡å–®ç¯„ä¾‹ï¼Œé©ç”¨æ–¼å…©å€‹å‘é‡ï¼ˆ`Vec<f32>`ï¼‰ä¹‹é–“çš„ç›¸ä¼¼åº¦è¨ˆç®—ï¼š

---

## ğŸ¦€ Rust å¯¦ä½œï¼šCosine Similarity å‡½æ•¸

```rust
fn cosine_similarity(a: &[f32], b: &[f32]) -> f32 {
    assert_eq!(a.len(), b.len(), "å‘é‡é•·åº¦å¿…é ˆç›¸åŒ");

    let dot_product: f32 = a.iter().zip(b.iter()).map(|(x, y)| x * y).sum();
    let norm_a: f32 = a.iter().map(|x| x * x).sum::<f32>().sqrt();
    let norm_b: f32 = b.iter().map(|x| x * x).sum::<f32>().sqrt();

    if norm_a == 0.0 || norm_b == 0.0 {
        return 0.0; // é¿å…é™¤ä»¥é›¶
    }

    dot_product / (norm_a * norm_b)
}
```

---

## ğŸ“¦ ä½¿ç”¨ç¯„ä¾‹

```rust
fn main() {
    let vec1 = vec![1.0, 2.0, 3.0];
    let vec2 = vec![4.0, 5.0, 6.0];

    let similarity = cosine_similarity(&vec1, &vec2);
    println!("Cosine Similarity: {:.4}", similarity);
}
```

è¼¸å‡ºçµæœï¼š
```
Cosine Similarity: 0.9746
```

---

## ğŸ§  å»¶ä¼¸å»ºè­°

- è‹¥ä½ è™•ç†çš„æ˜¯é«˜ç¶­åº¦åµŒå…¥å‘é‡ï¼ˆå¦‚ LLM çš„è¼¸å‡ºï¼‰ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ [`ndarray`](https://docs.rs/ndarray/latest/ndarray/) æ­é… SIMD åŠ é€Ÿã€‚
- è‹¥ä½ æƒ³è¦æ›´é«˜æ•ˆçš„æ¯”å°ï¼Œå¯ä»¥åƒè€ƒ [fast_vector_similarity](https://github.com/Dicklesworthstone/fast_vector_similarity) æˆ– [SimSIMD](https://github.com/ashvardanian/simsimd) é€™é¡é«˜æ•ˆå‘é‡æ¯”å°åº«ã€‚

---

å¦‚æœä½ æƒ³æŠŠé€™å€‹å‡½æ•¸æ•´åˆé€² Gemini CLI çš„åµŒå…¥æ¯”å°æµç¨‹ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¹«ä½ è¨­è¨ˆä¸€å€‹æ¨¡çµ„åŒ–æ¶æ§‹ã€‚è¦ä¸è¦æˆ‘å¹«ä½ åŒ…è£æˆ crate æˆ–åŠ ä¸Šå¤šåŸ·è¡Œç·’æ”¯æ´ï¼ŸğŸ¤“


å¯ä»¥çš„ï¼ŒLeoï¼PostgreSQL æ­é… **pgvector æ“´å……å¥—ä»¶**ï¼Œå®Œå…¨å¯ä»¥å¯¦ç¾ **Cosine Similarityï¼ˆé¤˜å¼¦ç›¸ä¼¼åº¦ï¼‰** çš„è¨ˆç®—èˆ‡æŸ¥è©¢ï¼Œè€Œä¸”æ•ˆç‡ç›¸ç•¶ä¸éŒ¯ï¼Œé©åˆç”¨åœ¨èªæ„æœå°‹ã€æ¨è–¦ç³»çµ±ç­‰å ´æ™¯ã€‚

---

## ğŸ§  pgvector å¦‚ä½•æ”¯æ´ Cosine Similarityï¼Ÿ

pgvector æä¾›å¤šç¨®å‘é‡è·é›¢é‹ç®—ç¬¦ï¼Œå…¶ä¸­ï¼š

- `<=>` æ˜¯ **Cosine Distance**ï¼ˆé¤˜å¼¦è·é›¢ï¼‰
- è‹¥è¦å–å¾— **Cosine Similarity**ï¼Œåªéœ€ç”¨ `1 - cosine_distance`

### ğŸ“Œ æŸ¥è©¢èªæ³•ç¯„ä¾‹ï¼š
```sql
SELECT 1 - (embedding <=> '[0.3, 0.2, 0.3]') AS cosine_similarity
FROM items
ORDER BY embedding <=> '[0.3, 0.2, 0.3]'
LIMIT 5;
```

é€™æ®µ SQL æœƒï¼š
- å°è³‡æ–™è¡¨ `items` ä¸­çš„å‘é‡æ¬„ä½ `embedding` åšé¤˜å¼¦ç›¸ä¼¼åº¦æ’åº
- å›å‚³æœ€ç›¸è¿‘çš„å‰ 5 ç­†è³‡æ–™

---

## âš™ï¸ å»ºç«‹ç´¢å¼•ä»¥åŠ é€ŸæŸ¥è©¢

è‹¥ä½ æœ‰å¤§é‡è³‡æ–™ï¼ˆä¾‹å¦‚æ•¸åè¬ç­†åµŒå…¥å‘é‡ï¼‰ï¼Œå¯ä»¥å»ºç«‹ **HNSW æˆ– IVFFlat ç´¢å¼•** ä¾†åŠ é€ŸæŸ¥è©¢ï¼š

```sql
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops);
```

é€™æ¨£å°±èƒ½åœ¨æŸ¥è©¢æ™‚ä½¿ç”¨è¿‘ä¼¼æœ€è¿‘é„°æœå°‹ï¼Œæå‡é€Ÿåº¦ã€‚

---

## âœ… å¯¦ä½œæ¢ä»¶

| æ¢ä»¶ | èªªæ˜ |
|------|------|
| PostgreSQL ç‰ˆæœ¬ | å»ºè­° 13 ä»¥ä¸Š |
| pgvector å®‰è£ | `CREATE EXTENSION vector;` |
| å‘é‡æ¬„ä½å‹åˆ¥ | `vector(n)`ï¼Œä¾‹å¦‚ `vector(384)` |
| æŸ¥è©¢æ–¹å¼ | ä½¿ç”¨ `<=>` é‹ç®—ç¬¦ï¼Œæ­é… `1 -` å–å¾—ç›¸ä¼¼åº¦ |

---

å¦‚æœä½ æ­£åœ¨è¨­è¨ˆèªæ„æœå°‹ç³»çµ±æˆ– RAG æ‡‰ç”¨ï¼Œé€™å€‹åŠŸèƒ½éå¸¸å¯¦ç”¨ã€‚è¦ä¸è¦æˆ‘å¹«ä½ å¯«ä¸€æ®µ Rust ç¨‹å¼ç¢¼ä¾†å‘¼å« Postgres ä¸¦åŸ·è¡Œé€™å€‹æŸ¥è©¢ï¼Ÿæˆ–è€…ä½ æƒ³æ•´åˆåˆ° Gemini CLI çš„æµç¨‹è£¡ï¼ŸğŸ¤“



å¤ªå¥½äº†ï¼é€™é‚Šæ˜¯ä½¿ç”¨ Rust æ­é… PostgreSQL å’Œ pgvector åŸ·è¡Œé¤˜å¼¦ç›¸ä¼¼åº¦æŸ¥è©¢çš„ç¯„ä¾‹æµç¨‹ã€‚ä½ å¯ä»¥ç”¨ä¾†é€£æ¥ Postgres è³‡æ–™åº«ã€åŸ·è¡Œ SQL æŸ¥è©¢ä¸¦å–å¾—èªæ„ç›¸ä¼¼åº¦ï¼š

---

## ğŸ¦€ Rust + PostgreSQLï¼ˆpgvectorï¼‰åŸ·è¡Œ Cosine Similarity æŸ¥è©¢

### ğŸ§± 1. è³‡æ–™è¡¨çµæ§‹é è¨­
å‡è¨­ä½ æœ‰ä¸€å€‹è³‡æ–™è¡¨ `items`ï¼Œè£¡é¢æœ‰ä¸€å€‹å‘é‡æ¬„ä½å«åš `embedding`ï¼š

```sql
CREATE TABLE items (
    id SERIAL PRIMARY KEY,
    embedding vector(1536) -- é€™è£¡çš„ç¶­åº¦ä¾ä½ åµŒå…¥æ¨¡å‹è€Œå®š
);
```

ä½ éœ€è¦å…ˆå®‰è£ `pgvector` æ“´å……å¥—ä»¶ï¼š

```sql
CREATE EXTENSION vector;
```

---

### ğŸ¦€ 2. Rust ç¨‹å¼ç¢¼ï¼ˆä½¿ç”¨ `tokio-postgres`ï¼‰

```rust
use tokio_postgres::{NoTls, Error};

#[tokio::main]
async fn main() -> Result<(), Error> {
    // é€£æ¥è³‡æ–™åº«
    let (client, connection) =
        tokio_postgres::connect("host=localhost user=postgres dbname=your_db", NoTls).await?;

    // Spawn ç”¨ä¾†ç¶­è­·é€£ç·šç‹€æ…‹
    tokio::spawn(async move {
        if let Err(e) = connection.await {
            eprintln!("Connection error: {}", e);
        }
    });

    // æŸ¥è©¢ï¼šç”¨ pgvector çš„ <=> åšé¤˜å¼¦è·é›¢ï¼Œå†è½‰æ›ç‚ºç›¸ä¼¼åº¦
    let query = r#"
        SELECT id, 1 - (embedding <=> $1::vector) AS cosine_similarity
        FROM items
        ORDER BY embedding <=> $1::vector
        LIMIT 5;
    "#;

    // å‡è¨­ä½ æœ‰ä¸€å€‹æŸ¥è©¢å‘é‡
    let query_vector = vec![0.3_f32, 0.2, 0.3]; // æ ¹æ“šä½ çš„åµŒå…¥æ¨¡å‹å‘é‡é•·åº¦èª¿æ•´

    // å°‡å‘é‡è½‰æˆ Postgres å¯ä»¥è¾¨è­˜çš„æ ¼å¼
    let vector_string = format!("{{{}}}", query_vector.iter().map(|v| v.to_string()).collect::<Vec<_>>().join(","));

    // åŸ·è¡ŒæŸ¥è©¢
    let rows = client.query(query, &[&vector_string]).await?;

    for row in rows {
        let id: i32 = row.get("id");
        let score: f32 = row.get("cosine_similarity");
        println!("ID: {}, Cosine Similarity: {:.4}", id, score);
    }

    Ok(())
}
```

---

## ğŸ§© å»¶ä¼¸åŠŸèƒ½å»ºè­°

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| ä½¿ç”¨ HNSW ç´¢å¼• | åŠ å¿«å‘é‡æ¯”å°é€Ÿåº¦ `CREATE INDEX ... USING hnsw(...)` |
| å‹•æ…‹å‘é‡ç”Ÿæˆ | å°‡æ–‡å­—åµŒå…¥åœ¨ Rust ä¸­è™•ç†ï¼Œå¦‚èª¿ç”¨ embedding API |
| æ•´åˆæª¢ç´¢å™¨ | æŠŠæŸ¥è©¢åŒ…è£æˆ Gemini CLI æ¨¡çµ„æˆ– LangChain Retriever |

---

å¦‚æœä½ æœ‰åµŒå…¥ API æˆ–è‡ªå·±çš„æ¨¡å‹è¼¸å‡ºå‘é‡ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¹«ä½ ä¸²æ¥æ•´å€‹æµç¨‹ã€‚è¦ä¸è¦æˆ‘å¹«ä½ è¨­è¨ˆä¸€å€‹ CLI å·¥å…·æ¨¡æ¿ï¼Œè¼¸å…¥ä¸€å¥è©±ç›´æ¥æŸ¥è©¢ç›¸ä¼¼å…§å®¹ï¼ŸğŸ˜
